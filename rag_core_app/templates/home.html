{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>RecallAI - Personalized AI Chatbot</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>

    <div style="display:none;">
        <form id="csrf-form">{% csrf_token %}</form>
    </div>

    <div class="chat-container">

        <div class="sidebar">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-weight: 300;">History</h3>
                <a href="{% url 'logout' %}" style="font-size: 0.8em; color: #ff6b6b; text-decoration: none;">Logout</a>
            </div>

            <a href="{% url 'home' %}" class="glass-btn" style="text-align: center; margin-bottom: 20px;">+ New Chat</a>

            <div style="flex: 1; overflow-y: auto;">
                <div class="space-y-1">
                    <div style="flex: 1; overflow-y: auto;">
                        {% for session in sessions %}

                        <div class="history-wrapper {% if current_session.id == session.id %}active{% endif %}">

                            <a href="{% url 'home' %}?session_id={{ session.id }}" class="history-link">
                                {{ session.title }}
                            </a>

                            <form action="{% url 'delete_chat_session' session.id %}" method="POST"
                                onsubmit="return confirm('Are you sure you want to delete this chat?');"
                                style="margin: 0;">
                                {% csrf_token %}
                                <button type="submit" class="delete-btn" title="Delete Chat">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </form>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-main">
            <div class="chat-header">
                <h2>RecallAI - Personalized AI Chatbot</h2>
                <div id="upload-progress" style="font-size: 0.9em; color: #a6c0fe; height: 20px; margin-top: 5px;">
                </div>
            </div>

            <div id="chat-box" class="chat-box">
                {% if not current_session %}
                <div class="message bot-msg">Hello! I'm ready. Upload a document or start chatting!</div>
                {% endif %}
                {% if current_session %}
                {% for msg in current_session.messages.all %}
                <div class="message {{ msg.is_user|yesno:'user-msg,bot-msg' }}">{{ msg.text|safe }}</div>
                {% endfor %}
                {% endif %}
            </div>

            <div class="input-area">
                <label
                    style="cursor: pointer; font-size: 1.2em; padding: 10px; border-radius: 50%; background: rgba(255,255,255,0.1); transition: 0.2s;"
                    title="Upload Files">
                    üìé
                    <input type="file" id="file-input" multiple style="display:none" onchange="uploadFiles(this.files)">
                </label>

                <input type="text" id="user-input" class="glass-input" style="margin:0;" placeholder="Ask something..."
                    onkeypress="handleEnter(event)">
                <button id="send-btn" class="glass-btn" style="width: auto; margin:0;"
                    onclick="sendMessage()">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = "{{ current_session.id|default:'null' }}";
        function getCsrfToken() { return document.querySelector('[name=csrfmiddlewaretoken]').value; }

        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll('.bot-msg').forEach(msg => { msg.innerHTML = marked.parse(msg.innerHTML); });
            scrollToBottom();
        });

        function scrollToBottom() {
            const box = document.getElementById('chat-box');
            box.scrollTop = box.scrollHeight;
        }

        function uploadFiles(files) {
            if (!files.length) return;
            const progress = document.getElementById('upload-progress');
            progress.innerText = "‚è≥ Uploading & Reading...";

            const formData = new FormData();
            for (let i = 0; i < files.length; i++) formData.append('files', files[i]);
            formData.append('session_id', currentSessionId); // Send ID to keep memory separate
            formData.append('csrfmiddlewaretoken', getCsrfToken());

            fetch('{% url "upload_api" %}', { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        progress.innerText = "‚úÖ Done!";

                        // 1. UPDATE SESSION IF NEW
                        if (data.session_id && currentSessionId === 'null') {
                            currentSessionId = data.session_id;
                            window.history.replaceState({}, '', `?session_id=${data.session_id}`);
                        }

                        // 2. SHOW FILE IN CHAT (The Visual Fix)
                        const box = document.getElementById('chat-box');
                        data.files.forEach(f => {
                            box.innerHTML += `
                                <div class="message user-msg" style="border-left: 3px solid #48bb78; background: rgba(72, 187, 120, 0.2);">
                                    üìÑ <strong>Uploaded:</strong> ${f.name} <br>
                                    <span style="font-size:0.8em; opacity:0.8;">${f.status}</span>
                                </div>
                                <div class="message bot-msg">
                                    I have processed <strong>${f.name}</strong>. You can now ask questions about it!
                                </div>
                             `;
                        });
                        scrollToBottom();
                    } else {
                        progress.innerText = "‚ùå Error";
                    }
                    setTimeout(() => { progress.innerText = ""; }, 3000);
                });
        }

        function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }

        function sendMessage() {
            const input = document.getElementById('user-input');
            const msg = input.value.trim();
            if (!msg) return;

            const box = document.getElementById('chat-box');
            box.innerHTML += `<div class="message user-msg">${msg}</div>`;
            input.value = '';
            scrollToBottom();

            const btn = document.getElementById('send-btn');
            btn.disabled = true;
            btn.style.opacity = "0.5";

            const formData = new FormData();
            formData.append('message', msg);
            formData.append('session_id', currentSessionId);
            formData.append('csrfmiddlewaretoken', getCsrfToken());

            fetch('{% url "chat_api" %}', { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    if (currentSessionId === 'null' && data.session_id) {
                        currentSessionId = data.session_id;
                        window.history.replaceState({}, '', `?session_id=${data.session_id}`);
                        // Reload to update sidebar title
                        setTimeout(() => location.reload(), 1000);
                    }
                    box.innerHTML += `<div class="message bot-msg">${marked.parse(data.response)}</div>`;
                    scrollToBottom();
                    btn.disabled = false;
                    btn.style.opacity = "1";
                });
        }
    </script>
</body>

</html>